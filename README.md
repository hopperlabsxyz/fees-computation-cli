# Fees Calculation Client

This project is a command-line Node.js client designed to calculate the amount of fees generated by each wallet within a specified time period. The client accepts input parameters that define the time range and relevant Vaults, and outputs the results in a structured CSV file.

### Inputs:
- Start block
- End block
- List of pairs `<Network, Vaults>`

### Functionality:
The client performs the following tasks:
- Fetches and processes event data within the specified block range.
- Calculates fees generated per wallet for each Vault.
- Aggregates and formats the results.

### Output:
The client generates a CSV file containing:
- Pair `<Network, Vault>`
- Wallet
- Amount of fees generated per wallet
- Price per share

## Calculate Fees Algorithm
The algorithm for calculating fees is as follows:
1. For each Settlement:
   - Start with the last settlement before or at the exact starting block time.
   - If starting with the settlement before the starting block time, the amount should be proportional between the two settlement periods.
   - Verify if any fees were taken (if no management and no performance fees), go to the next Settlement.
   - If fees were taken:
     - For each wallet (before deposit and withdraw):
       - Calculate the difference in balance of shares between the first and second settlement. This happens if any transfer of shares was made.
       - Retrieve/compute the total amount of fees that were taken.
       - Compute the proportion (in share value) of the fees the wallet participated in.
       - Add the proportion of the fees of this wallet to the previous settlement of taken Fees.
   - Finish when the last Settlement is processed.

## Getting Started

### Install npm
1. Download and install Node.js, which includes `npm`:
   - Visit the [Node.js download page](https://nodejs.org/).
   - Download the installer for your operating system.
   - Run the installer and follow the instructions to complete the installation.

2. Verify the installation:
   ```sh
   node -v
   npm -v
   ```

### Install pnpm and Dependencies
1. Install `pnpm` if you haven't already:
   ```sh
   npm install -g pnpm
   ```
2. Install the project dependencies:
   ```sh
   pnpm install
   ```

## Environment Setup

Before running the CLI, you need to create a `.env` file in the root directory of the project. This file should contain your Alchemy API key.

```sh
ALCHEMY_KEY=your-alchemy-api-key
```

Replace `your-alchemy-api-key` with your actual Alchemy API key.

## Fees Calculation CLI Usage

### Description
The Fees Calculation CLI is a tool that helps users determine the fees generated by individual wallets over a specified period. It can accept inputs either through a configuration file or as command-line parameters. The tool processes blockchain event data within the given block range, calculates the fees for each wallet associated with specified Vaults, and outputs the results in a CSV format for easy analysis and reporting.

### Command
To run the command, enter the following in your terminal:
```sh
pnpm compute <ChainId>:<VaultAddress>
```

### Building the OTC Deals CSV File
The OTC deals CSV file should contain the following columns:

- `chainId`: The ID of the blockchain network.
- `vaultAddress`: The address of the vault.
- `wallet`: The address of the wallet.
- `deal`: The deal percentage expressed in basis points (e.g., 8% should be expressed as 800).

Example of a CSV file:
```csv
chainId,vaultAddress,wallet,deal
1,0x07ed467acD4ffd13023046968b0859781cb90D9B,0x77acA7a5E3B67b8f36C1FdD7691eD85bbB54fB34,700
1,0x07ed467acD4ffd13023046968b0859781cb90D9B,0xbA4E4A09450B4106bE9a4DF3d85dA3F4617e6531,1000
```

### Command Options
The `index.ts` file defines the following command options:

- `-f, --firstBlock <number>`: Specifies the first block to be used in the computation.
- `-l, --lastBlock <number>`: Specifies the last block to be used in the computation.
- `-r, --readable`: Displays values with decimals for better readability.
- `-o, --output <string>`: Specifies the file path to export the CSV.
- `-d, --otc-deals <string>`: Specifies the path to a configuration file for OTC deals. The amount of % is express in 10^2. For exemple, 8% is express 800 into the csv file.

### Example
Example for all the lifetime of the Vault:
```sh
pnpm compute 1:0x07ed467acd4ffd13023046968b0859781cb90d9b
```

Example usage with all parameters:
```sh
pnpm compute 1:0x07ed467acd4ffd13023046968b0859781cb90d9b --firstBlock 1000000 --lastBlock 2000000 --readable --output fees.csv --otp-deals dealsExample.csv
```
